---
title: Optimisations for this site
author: jonas
layout: post
date: 14.05.2015
permalink: /optimisations/
---

This site is quite simple but I invested some time to make it as fast as possible. I learned some things during development I want to share.

* Built with Jekyll
* PageSpeed: 100/100

### Visiting the site

The following numbers will vary depending on your environment (device, internet connection) and your internet speed. Before visiting each page, I disabled the cache and emptied it.

#### Index Page (You have installed Source Sans Pro locally)

* Resources: 3
* Page weight: 32.0 KB
* Loading time: 266ms

#### An article without images (You have installed Source Sans Pro locally)

* Resources: 4
* Page weight: 33.1 KB
* Loading time: 267ms

#### Index Page (You have not installed Source Sans Pro locally)

* Resources: 6
* Page weight: 470.0 KB
* Loading time: 449ms

#### An article without images (You have not installed Source Sans Pro locally)

* Resources: 7
* Page weight: 471.1 KB 
* Loading time: 624ms

### Use fallback fonts

After I optimised many parts of the site the page loaded very fast but the fonts did not. I noticed this when I had a throttled internet connection. “Source Sans Pro Regular” weights 150 KB. In total, I load 566 KB font files (Bold, Italic, Regular, Semibold) if they are needed on the page.

My goal was to first load Helvetica to prevent a white screen (because everything loaded except the fonts). When the fonts loaded I want to apply them.

To achieve this, just embed a copy of [Font Face Observer](https://github.com/bramstein/fontfaceobserver) and use the following script.

<pre><code class="language-javascript">var observer = new FontFaceObserver(‘Source Sans Pro’, {});
var body = document.getElementsByTagName(“body”)[0];
	
observer.check().then(function () {
	body.className = 'fonts-loaded';
});
</code></pre>

When the fonts loaded, the class “fonts-loaded” will be added the ``<body>`` element. In your CSS use it like this:

<pre><code class="language-css">body {
	font-family: 'Helvetica', sans-serif;
}

.fonts-loaded {
	font-family: 'Source Sans Pro';
}
</code></pre>


### Use the ``local`` property in ``@font-face``

Some users may have your font installed locally. So why would you load it? You can easily use the ``local`` property in ``@font-face`` like this:

<pre><code class="language-css">@font-face {
	font-family: 'Source Sans Pro';
	src: local('Source Sans Pro Regular'),
	local('SourceSansPro-Regular'),
	url(../assets/SourceSansPro-Regular.ttf);
	font-weight: normal;
}
</code></pre>

### Running gulp tasks in a row is impossible

Gulp tasks always run asynchronous. There is no way to change this because this is how Javascript works. There is a gulp plugin called [run-sequence](https://www.npmjs.com/package/run-sequence) trying to solve this problem. To detect wether a task has finished you have to ``return`` something which is not always possible (e.g. with the [critical task](https://github.com/addyosmani/critical)).

In your shell you could use something like this:

<pre><code class="language-javascript">gulp jekyll && gulp critical && gulp html</code></pre>

It waits for the jekyll task to finish, then runs the critical task and after this task is done, it runs the html task. I installed [gulp-shell](https://www.npmjs.com/package/gulp-shell) and then created a simple gulp task:

<pre><code class="language-javascript">var shell = require('gulp-shell');
gulp.task('build', shell.task([
   	'gulp jekyll && gulp critical && gulp html'
]));
</code></pre>

### Cache and compress everything (it is easy)

Caching and compression is easy. If your site runs on an Apache you can enable caching and compression using the ``.htaccess`` file. You can find mine [here](https://github.com/jonicious/jonas.re/blob/master/.htaccess).

### Do not use the build in Jekyll SCSS preprocessor

Jekyll has a build in SCSS preprocessor. It works great but you should disable it if you use gulp for tasks like autoprefix and minify your (S)CSS.

By running ``jekyll build``, everything except the folders beginning with a underscore will be cloned to the ``_site`` folder. If you want to exclude files or folders, add them in your ``_config.yml`` within the ``exclude`` tag.

<pre><code class="language-javascript">exclude: [
	'/node_modules',
	'gulpfile.js',
	'package.json',
	'README.md',
 	'/css/style.scss'
]
</code></pre>

``jekyll build`` also overwrites every file from the ``_site`` directory that is not generated by Jekyll. That is particularly annoying if you use a build system like gulp.js which is very likely to save files there. For that, you have to use the ``keep_files`` tag.

<pre><code class="language-javascript">keep_files: [
	'css/style.css',
	'_site/.htaccess'
]
</code></pre>

### Misc

* Minify your JS
* Minify your CSS
* Minify your HTML
* Use critical CSS
* Add the ``_site/`` directory to your ``.gitignore``

**You can find the whole code of the site on [Github](https://github.com/jonicious/jonas.re/tree/master).** (If you find any grammatical errors or have feedback what to do better feel free to open an [issue](https://github.com/jonicious/jonas.re/issues).)
